<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Shaka Player + Playlist + Remote Control + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á  + ‡∏Å‡∏î1‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</title>
  <!-- ‡πÇ‡∏´‡∏•‡∏î Shaka Player -->
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.7.0/dist/shaka-player.compiled.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; background: #000; color: #fff; display: flex; height: 100vh; }
    #menu { width: 300px; background: #6a1b9a; overflow-y: auto; padding: 10px; }
    .group h3 { margin: 0; padding: 8px; background: #7e57c2; border-radius: 4px; cursor: pointer; }
    .item-list { display: none; padding-left: 10px; }
    .item { display: flex; align-items: center; margin: 4px 0; padding: 6px; background: #9575cd; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
    .item img { width: 60px; height: 35px; object-fit: cover; margin-right: 8px; }
    .item.active { background: #f06292; }
    .item:hover, .item:focus { background: yellow; color: black; outline: none; }
    .focus-player { outline: 3px solid yellow; }
    #player { flex: 1; position: relative; }
    #video { width: 100%; height: 100%; background: #000; }
    .error-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff6b6b; font-size: 18px; text-align: center; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; }
    .loading-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #4ecdc4; font-size: 18px; text-align: center; }
  </style>
</head>
<body>
  <div id="menu"><h2>üì∫ Playlist</h2><div id="playlist"></div></div>
  <div id="player">
    <video id="video" controls crossorigin="anonymous"></video>
    <div id="loading" class="loading-message" style="display: none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <div id="error" class="error-message" style="display: none;"></div>
  </div>

  <script>
    const playlistURLs = ["https://dl.dropbox.com/scl/fi/crrobvdwowocm61wxkr35/series-indy-1.m3u?rlkey=6vcsjrmshl8lj54shy2ftn8d7&dl=1"];
    let shakaPlayer;
    let focusIndex = 0; // index ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π
    let mode = "menu"; // menu ‡∏´‡∏£‡∏∑‡∏≠ player
    let useNativePlayer = false; // fallback flag

    async function loadPlaylist() {
      for (let url of playlistURLs) {
        try {
          const res = await fetch(url);
          const text = await res.text();
          if (url.endsWith(".json")) return JSON.parse(text);
          const lines = text.split("\n");
          let list = [], cur = {};
          for (let line of lines) {
            line = line.trim();
            if (line.startsWith("#EXTINF")) {
              cur = {
                title: line.split(",").pop().trim(),
                group: (line.match(/group-title="(.*?)"/) || ["",""])[1] || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà",
                image: (line.match(/tvg-logo="(.*?)"/) || ["",""])[1] || ""
              };
            } else if (line && !line.startsWith("#")) {
              cur.file = line;
              list.push({ ...cur });
            }
          }
          return list;
        } catch (error) {
          console.error("Error loading playlist:", error);
        }
      }
      return [];
    }

    function renderMenu(list) {
      const menu = document.getElementById("playlist");
      menu.innerHTML = "";
      const groups = [...new Set(list.map(x => x.group))];
      groups.forEach(group => {
        const gd = document.createElement("div"), hd = document.createElement("h3"), il = document.createElement("div");
        gd.className = "group";
        hd.textContent = group;
        il.className = "item-list";
        hd.onclick = () => il.style.display = il.style.display === "block" ? "none" : "block";
        list.filter(x => x.group === group).forEach(item => {
          const it = document.createElement("div");
          it.className = "item";
          it.tabIndex = 0;
          it.innerHTML = item.image ? `<img src="${item.image}"><span>${item.title}</span>` : item.title;
          it.onclick = () => {
            document.querySelectorAll(".item").forEach(e => e.classList.remove("active"));
            it.classList.add("active");
            loadVideo(item);
          };
          il.appendChild(it);
        });
        gd.append(hd, il); menu.appendChild(gd);
      });
      const firstList = document.querySelector(".item-list");
      if (firstList) firstList.style.display = "block";
    }

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showError(message) {
      hideLoading();
      const errorDiv = document.getElementById('error');
      errorDiv.innerHTML = message;
      errorDiv.style.display = 'block';
      
      // Hide error after 5 seconds
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    async function loadVideo(item) {
      console.log('Loading stream:', item.file);
      showLoading();
      
      // Destroy previous player if exists
      if (shakaPlayer) {
        shakaPlayer.destroy();
        shakaPlayer = null;
      }

      const video = document.getElementById('video');
      
      // Try Shaka Player first if not using native player
      if (!useNativePlayer && shaka.Player.isBrowserSupported()) {
        try {
          await loadWithShakaPlayer(video, item.file);
          return;
        } catch (error) {
          console.log('Shaka Player failed, trying native player:', error);
          useNativePlayer = true; // Switch to native player for subsequent attempts
        }
      }
      
      // Fallback to native HTML5 video player
      loadWithNativePlayer(video, item.file);
    }

    async function loadWithShakaPlayer(video, url) {
      shakaPlayer = new shaka.Player(video);
      
      // Configure networking
      shakaPlayer.configure({
        streaming: {
          retryParameters: {
            timeout: 30000,
            maxAttempts: 3,
            baseDelay: 1000,
            backoffFactor: 2,
            fuzzFactor: 0.5
          }
        },
        manifest: {
          retryParameters: {
            timeout: 30000,
            maxAttempts: 3,
            baseDelay: 1000,
            backoffFactor: 2,
            fuzzFactor: 0.5
          }
        }
      });

      // Add request filter to handle CORS
      shakaPlayer.getNetworkingEngine().registerRequestFilter((type, request) => {
        // Add headers to help with CORS
        request.headers['Access-Control-Allow-Origin'] = '*';
        request.headers['Access-Control-Allow-Methods'] = 'GET, POST, OPTIONS';
        request.headers['Access-Control-Allow-Headers'] = 'Content-Type';
      });

      shakaPlayer.addEventListener('error', (event) => {
        const error = event.detail;
        console.error('Shaka Player error:', error);
        throw error;
      });

      await shakaPlayer.load(url);
      hideLoading();
      console.log('Shaka Player: Video loaded successfully');
      
      // Auto-play
      video.play().catch(e => {
        console.log('Auto-play prevented:', e);
      });
    }

    function loadWithNativePlayer(video, url) {
      console.log('Using native HTML5 player');
      
      video.src = url;
      video.load();
      
      video.addEventListener('loadstart', () => {
        console.log('Native player: Loading started');
      });
      
      video.addEventListener('canplay', () => {
        hideLoading();
        console.log('Native player: Video can start playing');
        
        // Auto-play
        video.play().catch(e => {
          console.log('Auto-play prevented:', e);
        });
      });
      
      video.addEventListener('error', (e) => {
        console.error('Native player error:', e);
        showError(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏î‡πâ<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô`);
      });
      
      video.addEventListener('stalled', () => {
        console.log('Native player: Playback stalled');
      });
      
      video.addEventListener('waiting', () => {
        console.log('Native player: Waiting for data');
      });
    }

    function setFocus(index) {
      const items = document.querySelectorAll(".item");
      if (items.length === 0) return;
      if (index < 0) index = items.length - 1;
      if (index >= items.length) index = 0;
      focusIndex = index;
      items.forEach(e => e.classList.remove("focus"));
      items[focusIndex].focus();
    }

    function handleRemoteControl(e) {
      const items = document.querySelectorAll(".item");
      if (items.length === 0) return;

      if (mode === "menu") {
        switch (e.key) {
          case "ArrowDown":
            setFocus(focusIndex + 1);
            break;
          case "ArrowUp":
            setFocus(focusIndex - 1);
            break;
          case "Enter":
          case " ":
            items[focusIndex].click();
            break;
          case "ArrowRight":
          case "Tab":
            mode = "player";
            document.getElementById("player").classList.add("focus-player");
            break;
        }
      } else if (mode === "player") {
        const video = document.getElementById('video');
        switch (e.key) {
          case "ArrowLeft":
            mode = "menu";
            document.getElementById("player").classList.remove("focus-player");
            break;
          case "Enter":
          case " ":
            if (video.paused) {
              video.play();
            } else {
              video.pause();
            }
            break;
          case "1": // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç 1 ‡∏™‡∏•‡∏±‡∏ö fullscreen
            toggleFullscreen();
            break;
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö fullscreen
    function toggleFullscreen() {
      const playerElement = document.getElementById("player");
      if (!document.fullscreenElement) {
        if (playerElement.requestFullscreen) {
          playerElement.requestFullscreen();
        } else if (playerElement.webkitRequestFullscreen) { // Safari
          playerElement.webkitRequestFullscreen();
        } else if (playerElement.msRequestFullscreen) { // IE11
          playerElement.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) { // Safari
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) { // IE11
          document.msExitFullscreen();
        }
      }
    }

    async function init() {
      console.log('Initializing player...');
      
      const list = await loadPlaylist();
      if (list.length === 0) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≠‡∏á');
        return;
      }
      
      renderMenu(list);
      const first = document.querySelector(".item");
      if (first) {
        setFocus(0);
        first.click();
      }
      document.addEventListener("keydown", handleRemoteControl);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

